<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luthfi Music Web App</title>
    
    <!-- 1. STYLING: Memuat Tailwind CSS dari CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. IKON: Memuat Lucide Icons dari CDN -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    
    <!-- PWA Manifest & Theme Color -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1DB954">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/1DB954/FFFFFF?text=LM">

    <!-- 3. CSS KUSTOM -->
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #121212; }
        ::-webkit-scrollbar-thumb { background: #535353; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #737373; }
        audio::-webkit-media-controls-panel { background-color: #282828; }
        audio::-webkit-media-controls-play-button, audio::-webkit-media-controls-mute-button { background-color: #fff; border-radius: 50%; }
        audio::-webkit-media-controls-current-time-display, audio::-webkit-media-controls-time-remaining-display { color: #b3b3b3; }
        .lucide-play { fill: black; }
        .sidebar-item.active { background-color: #282828; color: white; }
        .sort-btn.active { background-color: #22c55e; color: white; }
        
        body {
            background-color: #000;
        }
        .bg-main-content {
            background-image: linear-gradient(to bottom, rgba(17, 24, 39, 0.85), rgba(0, 0, 0, 0.95));
        }
        .bg-sidebar {
            background-color: rgba(0, 0, 0, 0.85);
        }
        .bg-footer {
             background-color: rgba(17, 24, 39, 0.9);
             backdrop-filter: blur(4px);
        }
        #category-dropdown {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        .line-clamp-3 {
           overflow: hidden;
           display: -webkit-box;
           -webkit-box-orient: vertical;
           -webkit-line-clamp: 3;
        }
    </style>
</head>
<body class="text-gray-300 font-sans">
    
    <!-- Canvas untuk animasi background -->
    <canvas id="wave-canvas" class="fixed top-0 left-0 w-full h-full -z-10"></canvas>

    <!-- 4. STRUKTUR HTML -->
    <div class="h-screen flex flex-col">
        <div class="flex flex-1 overflow-hidden">
            
            <!-- Sidebar hanya untuk Desktop -->
            <aside class="hidden md:flex w-64 bg-sidebar p-4 flex-shrink-0 overflow-y-auto flex-col space-y-6">
                <!-- Profil Section -->
                <div class="text-center p-4 border-b border-gray-800">
                    <img src="https://placehold.co/100x100/1DB954/FFFFFF?text=Luthfi" alt="Foto Profil Luthfi" class="w-24 h-24 rounded-full mx-auto mb-4 border-2 border-green-500">
                    <h3 class="text-lg font-bold text-white">Luthfi</h3>
                    <p class="text-xs text-gray-400 mt-1">Selamat datang di aplikasi musik pribadi saya. Nikmati koleksi lagu pilihan terbaik.</p>
                    
                    <div class="mt-4">
                        <a href="#" target="_blank" class="text-sm text-green-400 hover:underline">
                            Kunjungi Bio Saya
                        </a>
                        <div class="flex justify-center gap-4 mt-3">
                            <a href="#" target="_blank" title="Instagram" class="text-gray-400 hover:text-white"><i data-lucide="instagram" class="w-5 h-5"></i></a>
                            <a href="#" target="_blank" title="TikTok" class="text-gray-400 hover:text-white"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-2.43.05-4.86-.95-6.69-2.81-1.77-1.8-2.55-4.16-2.4-6.6s.92-4.67 2.56-6.44c1.64-1.77 3.9-2.57 6.16-2.44.02 1.58-.02 3.16.01 4.73-.02 1.08-.36 2.14-1.05 2.95-.95 1.12-2.32 1.66-3.73 1.55-1.22-.09-2.39-.68-3.19-1.59-.53-.6-.82-1.36-.87-2.16-.07-1.15.25-2.31.97-3.26 1.45-1.9 3.96-2.62 6.17-1.69z"></path></svg></a>
                            <a href="#" target="_blank" title="Facebook" class="text-gray-400 hover:text-white"><i data-lucide="facebook" class="w-5 h-5"></i></a>
                        </div>
                    </div>
                </div>

                <div>
                    <h2 class="text-xl font-bold text-white mb-4">Kategori</h2>
                    <div id="category-list" class="space-y-2"></div>
                    <button id="toggle-categories-btn" class="text-sm text-gray-400 hover:text-white mt-4 hidden">
                        Tampilkan Lebih Banyak
                    </button>
                </div>
            </aside>

            <!-- Konten Utama -->
            <main class="flex-1 bg-main-content p-4 md:p-6 overflow-y-auto">
                <!-- [DIPERBARUI] Header Mobile dengan Foto Profil -->
                <header class="md:hidden mb-4">
                    <div class="flex justify-between items-center">
                        <h1 class="text-2xl font-bold text-white">Luthfi Music</h1>
                        <img src="https://placehold.co/100x100/1DB954/FFFFFF?text=Luthfi" alt="Foto Profil" class="w-10 h-10 rounded-full border-2 border-green-500">
                    </div>
                    <div class="mt-4 space-y-4">
                         <div class="relative">
                            <input type="search" id="search-input-mobile" placeholder="Cari lagu atau artis..." class="w-full bg-gray-800 text-white rounded-full py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-green-500">
                            <div class="absolute left-3 top-1/2 -translate-y-1/2"><i data-lucide="search" class="text-gray-400"></i></div>
                        </div>
                        <div class="flex items-center gap-2">
                             <select id="category-dropdown" class="w-full bg-gray-800 text-white rounded-full py-2 px-4 focus:outline-none focus:ring-2 focus:ring-green-500"></select>
                            <button id="sort-az-btn-mobile" class="sort-btn active p-2 bg-gray-800 rounded-full hover:bg-gray-700 transition-colors" title="Urutkan A-Z"><i data-lucide="arrow-down-a-z" class="w-5 h-5"></i></button>
                            <button id="sort-za-btn-mobile" class="sort-btn p-2 bg-gray-800 rounded-full hover:bg-gray-700 transition-colors" title="Urutkan Z-A"><i data-lucide="arrow-down-z-a" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                </header>

                <!-- Header Desktop -->
                <div class="hidden md:flex justify-between items-center mb-6 gap-4">
                    <h1 class="text-3xl font-bold text-white flex-shrink-0">Luthfi Music Web App</h1>
                    <div class="flex items-center gap-4 w-full justify-end">
                        <div class="flex items-center gap-2">
                            <button id="sort-az-btn" class="sort-btn active p-2 bg-gray-800 rounded-full hover:bg-gray-700 transition-colors" title="Urutkan A-Z"><i data-lucide="arrow-down-a-z" class="w-5 h-5"></i></button>
                            <button id="sort-za-btn" class="sort-btn p-2 bg-gray-800 rounded-full hover:bg-gray-700 transition-colors" title="Urutkan Z-A"><i data-lucide="arrow-down-z-a" class="w-5 h-5"></i></button>
                        </div>
                        <div class="relative w-1/2 max-w-xs">
                            <input type="search" id="search-input" placeholder="Cari lagu atau artis..." class="w-full bg-gray-800 text-white rounded-full py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-green-500">
                            <div class="absolute left-3 top-1/2 -translate-y-1/2"><i data-lucide="search" class="text-gray-400"></i></div>
                        </div>
                    </div>
                </div>
                
                <!-- Container lagu dengan class responsif dan maksimal 4 kolom -->
                <div id="song-list" class="flex flex-col md:grid md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6"></div>
            </main>
        </div>

        <!-- Player Bawah -->
        <footer class="bg-footer border-t border-gray-800 p-4 text-white">
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                <div class="flex items-center w-full sm:w-1/3">
                    <img id="current-album-art" src="https://placehold.co/64x64/1DB954/FFFFFF?text=Musik" alt="Album Art" class="w-16 h-16 rounded-md mr-4 shadow-lg">
                    <div class="overflow-hidden">
                        <h3 id="current-song-title" class="font-semibold truncate">Pilih sebuah lagu</h3>
                        <p id="current-song-artist" class="text-sm text-gray-400 truncate">Tidak ada yang diputar</p>
                    </div>
                </div>
                <div class="w-full sm:w-2/3">
                    <audio id="audio-player" controls class="w-full"></audio>
                </div>
            </div>
            <div class="text-center text-xs text-gray-500 mt-2"><p>&copy; 2025 Luthfi Kurnia</p></div>
        </footer>
    </div>

    <!-- 5. LOGIKA JAVASCRIPT -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const GOOGLE_SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbxMEdy7CcgQxQG7o8MXRHf-5gH0OtnPSoyngMuLqgZpmyRjHhBJG0QPdzDXeSHnrlEN/exec';
            
            // --- Animasi Background ---
            const canvas = document.getElementById('wave-canvas');
            const ctx = canvas.getContext('2d');
            let step = 0, hue = 200;
            const waves = [
                { y: 0, length: 0.02, amplitude: 120, frequency: 0.02, opacity: 0.5 },
                { y: 0, length: 0.03, amplitude: 150, frequency: 0.015, opacity: 0.3 },
                { y: 0, length: 0.015, amplitude: 100, frequency: 0.025, opacity: 0.8 }
            ];
            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                waves.forEach(w => w.y = canvas.height / 2);
            }
            function animateWave() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                hue += 0.5;
                waves.forEach(wave => {
                    const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
                    gradient.addColorStop(0, `hsla(${hue}, 100%, 50%, 0)`);
                    gradient.addColorStop(0.5, `hsla(${hue}, 100%, 50%, ${wave.opacity})`);
                    gradient.addColorStop(1, `hsla(${hue + 60}, 100%, 50%, 0)`);
                    ctx.beginPath();
                    ctx.moveTo(0, wave.y);
                    for (let i = 0; i < canvas.width; i++) ctx.lineTo(i, wave.y + Math.sin(i * wave.length + step) * wave.amplitude * Math.sin(step * 0.1));
                    ctx.strokeStyle = gradient; ctx.lineWidth = 2; ctx.stroke(); ctx.closePath();
                });
                step += 0.02; requestAnimationFrame(animateWave);
            }
            window.addEventListener('resize', resizeCanvas); resizeCanvas(); animateWave();

            // --- ELEMEN DOM ---
            const songListContainer = document.getElementById('song-list');
            const categoryList = document.getElementById('category-list');
            const categoryDropdown = document.getElementById('category-dropdown');
            const audioPlayer = document.getElementById('audio-player');
            const currentAlbumArt = document.getElementById('current-album-art');
            const currentSongTitle = document.getElementById('current-song-title');
            const currentSongArtist = document.getElementById('current-song-artist');
            const searchInput = document.getElementById('search-input');
            const searchInputMobile = document.getElementById('search-input-mobile');
            const sortAzBtn = document.getElementById('sort-az-btn'), sortZaBtn = document.getElementById('sort-za-btn');
            const sortAzBtnMobile = document.getElementById('sort-az-btn-mobile'), sortZaBtnMobile = document.getElementById('sort-za-btn-mobile');

            // --- STATE APLIKASI ---
            let allSongs = [], selectedCategories = new Set(), currentSong = null, currentQueue = [], currentSortOrder = 'a-z';

            // --- FUNGSI UTAMA ---
            async function fetchSongs(apiUrl) {
                try {
                    const response = await fetch(apiUrl);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    allSongs = await response.json();
                    if (allSongs.length === 0) { showError('Tidak ada lagu ditemukan.'); return; }
                    renderCategories();
                    applyFiltersAndRender();
                    lucide.createIcons();
                } catch (error) { console.error('Gagal mengambil data:', error); showError('Gagal memuat data. Periksa URL API Anda.'); }
            }
            
            function showError(message) { songListContainer.innerHTML = `<div class="col-span-full text-center p-8 bg-red-900/50 rounded-lg"><h3 class="text-xl text-white font-bold">Oops!</h3><p class="text-red-300 mt-2">${message}</p></div>`; }

            // --- FUNGSI RENDER ---
            function renderCategories() {
                const categories = new Set();
                allSongs.forEach(song => song.kategori && song.kategori.split(',').forEach(cat => categories.add(cat.trim())));
                const sortedCategories = Array.from(categories).sort();
                
                categoryList.innerHTML = '';
                categoryDropdown.innerHTML = '';

                const allCatOption = document.createElement('option');
                allCatOption.value = 'Semua Kategori';
                allCatOption.textContent = 'Semua Kategori';
                categoryDropdown.appendChild(allCatOption);
                
                const allCatElement = createCategoryElement('Semua Kategori');
                allCatElement.classList.add('active');
                allCatElement.addEventListener('click', () => handleCategoryClick('Semua Kategori'));
                categoryList.appendChild(allCatElement);

                sortedCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categoryDropdown.appendChild(option);

                    const element = createCategoryElement(category);
                    element.addEventListener('click', () => handleCategoryClick(category));
                    categoryList.appendChild(element);
                });
            }
            
            function createCategoryElement(name) {
                const element = document.createElement('div');
                element.className = 'p-2 rounded-md cursor-pointer hover:bg-gray-800 transition-colors sidebar-item';
                element.textContent = name;
                element.dataset.category = name;
                return element;
            }

            function renderSongs(songs) {
                currentQueue = songs;
                songListContainer.innerHTML = '';
                if (songs.length === 0) { songListContainer.innerHTML = `<p class="col-span-full text-center">Lagu tidak ditemukan.</p>`; return; }
                
                songs.forEach(song => {
                    const songItem = document.createElement('div');
                    songItem.className = 'bg-gray-900/80 backdrop-blur-sm rounded-lg hover:bg-gray-800/80 transition-all cursor-pointer group flex items-center p-2 md:p-4 md:flex-col md:items-start';
                    songItem.innerHTML = `
                        <div class="relative w-16 h-16 md:w-full md:h-auto flex-shrink-0">
                            <img src="${song.urlGambar || 'https://placehold.co/200x200/1DB954/FFFFFF?text=M'}" alt="${song.judulLagu}" class="w-full h-full md:h-auto rounded-md shadow-lg md:mb-4 aspect-square object-cover">
                            <button class="absolute bottom-1 right-1 md:bottom-2 md:right-2 w-10 h-10 md:w-12 md:h-12 bg-green-500 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transform group-hover:translate-y-0 translate-y-2 transition-all duration-300 shadow-lg">
                                <i data-lucide="play" class="w-5 h-5 md:w-6 md:h-6"></i>
                            </button>
                        </div>
                        <div class="ml-4 md:ml-0 flex-grow overflow-hidden">
                            <h4 class="text-white font-semibold line-clamp-3 h-18">${song.judulLagu}</h4>
                            <p class="text-sm text-gray-400 truncate">${song.namaArtis}</p>
                        </div>
                    `;
                    songItem.addEventListener('click', () => playSong(song));
                    songListContainer.appendChild(songItem);
                });
                lucide.createIcons();
            }

            // --- FUNGSI LOGIKA & FILTER ---
            function applyFiltersAndRender() {
                let filteredSongs = [...allSongs];
                const searchTerm = (window.innerWidth < 768 ? searchInputMobile.value : searchInput.value).toLowerCase();

                if (searchTerm) filteredSongs = filteredSongs.filter(s => s.judulLagu.toLowerCase().includes(searchTerm) || s.namaArtis.toLowerCase().includes(searchTerm));
                if (selectedCategories.size > 0) filteredSongs = filteredSongs.filter(s => s.kategori && s.kategori.split(',').map(c => c.trim()).some(cat => selectedCategories.has(cat)));
                if (currentSortOrder === 'a-z') filteredSongs.sort((a, b) => a.judulLagu.localeCompare(b.judulLagu));
                else if (currentSortOrder === 'z-a') filteredSongs.sort((a, b) => b.judulLagu.localeCompare(a.judulLagu));
                
                renderSongs(filteredSongs);
            }

            function playSong(song) {
                currentSong = song;
                audioPlayer.src = song.urlAudio;
                currentAlbumArt.src = song.urlGambar || 'https://placehold.co/64x64/1DB954/FFFFFF?text=M';
                currentSongTitle.textContent = song.judulLagu;
                currentSongArtist.textContent = song.namaArtis;
                audioPlayer.play().catch(error => console.error("Gagal memutar audio:", error));
            }

            function playNextSong() {
                if (!currentSong || currentQueue.length === 0) return;
                const currentIndex = currentQueue.findIndex(s => s.judulLagu === currentSong.judulLagu);
                if (currentIndex === -1) return;
                const nextIndex = (currentIndex + 1) % currentQueue.length;
                playSong(currentQueue[nextIndex]);
            }

            // --- EVENT HANDLERS ---
            function handleCategoryClick(category) {
                selectedCategories.clear();
                if (category !== 'Semua Kategori') selectedCategories.add(category);
                
                document.querySelectorAll('#category-list .sidebar-item').forEach(el => {
                    el.classList.toggle('active', el.dataset.category === category);
                });
                categoryDropdown.value = category;
                
                applyFiltersAndRender();
            }

            function handleSortClick(order) {
                currentSortOrder = order;
                [sortAzBtn, sortAzBtnMobile].forEach(btn => btn.classList.toggle('active', order === 'a-z'));
                [sortZaBtn, sortZaBtnMobile].forEach(btn => btn.classList.toggle('active', order === 'z-a'));
                applyFiltersAndRender();
            }

            // --- EVENT LISTENERS ---
            [searchInput, searchInputMobile].forEach(input => input.addEventListener('input', applyFiltersAndRender));
            audioPlayer.addEventListener('ended', playNextSong);
            [sortAzBtn, sortAzBtnMobile].forEach(btn => btn.addEventListener('click', () => handleSortClick('a-z')));
            [sortZaBtn, sortZaBtnMobile].forEach(btn => btn.addEventListener('click', () => handleSortClick('z-a')));
            categoryDropdown.addEventListener('change', (e) => handleCategoryClick(e.target.value));

            if (!GOOGLE_SHEET_API_URL || !GOOGLE_SHEET_API_URL.startsWith('https://script.google.com')) {
                showError("URL API Google Sheet tidak valid. Harap periksa kembali URL di dalam kode.");
            } else {
                fetchSongs(GOOGLE_SHEET_API_URL);
            }
        });
    </script>
    
    <!-- PWA Service Worker (tidak berubah) -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(reg => console.log('SW registered.'), err => console.log('SW registration failed:', err));
            });
        }
    </script>
    
    <!--
    ================================================================================
    PENTING: File `manifest.json` dan `sw.js` masih diperlukan agar fitur
    "Install Web App" berfungsi. Pastikan kedua file tersebut ada di folder
    yang sama dengan file HTML ini.
    ================================================================================
    -->

</body>
</html>
