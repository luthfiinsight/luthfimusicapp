<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luthfi Music Web App</title>
    
    <!-- 1. STYLING: Memuat Tailwind CSS dari CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. IKON: Memuat Lucide Icons dari CDN -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    
    <!-- PWA Manifest & Theme Color -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1DB954">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/1DB954/FFFFFF?text=LM">

    <!-- 3. CSS KUSTOM -->
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #121212; }
        ::-webkit-scrollbar-thumb { background: #535353; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #737373; }
        audio::-webkit-media-controls-panel { background-color: #282828; }
        audio::-webkit-media-controls-play-button, audio::-webkit-media-controls-mute-button { background-color: #fff; border-radius: 50%; }
        audio::-webkit-media-controls-current-time-display, audio::-webkit-media-controls-time-remaining-display { color: #b3b3b3; }
        .lucide-play { fill: black; }
        .sidebar-item.active { background-color: #282828; color: white; }
        .sort-btn.active { background-color: #22c55e; color: white; }
        
        body {
            background-color: #000; /* Fallback jika canvas gagal */
        }
        .bg-main-content {
            background-image: linear-gradient(to bottom, rgba(17, 24, 39, 0.85), rgba(0, 0, 0, 0.95));
        }
        .bg-sidebar {
            background-color: rgba(0, 0, 0, 0.85);
        }
        .bg-footer {
             background-color: rgba(17, 24, 39, 0.9);
             backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="text-gray-300 font-sans">
    
    <!-- Canvas untuk animasi background -->
    <canvas id="wave-canvas" class="fixed top-0 left-0 w-full h-full -z-10"></canvas>

    <!-- 4. STRUKTUR HTML -->
    <div class="h-screen flex flex-col">
        <div class="flex flex-1 overflow-hidden">
            
            <!-- Sidebar -->
            <aside class="w-64 bg-sidebar p-4 flex-shrink-0 overflow-y-auto flex flex-col space-y-6">
                <!-- Profil Section -->
                <div class="text-center p-4 border-b border-gray-800">
                    <img src="https://placehold.co/100x100/1DB954/FFFFFF?text=Luthfi Kurnia" alt="Foto Profil Luthfi" class="w-24 h-24 rounded-full mx-auto mb-4 border-2 border-green-500">
                    <h3 class="text-lg font-bold text-white">Luthfi</h3>
                    <p class="text-xs text-gray-400 mt-1">Selamat datang di aplikasi musik pribadi saya. Nikmati koleksi lagu pilihan terbaik.</p>
                    
                    <!-- Bio & Social Media Links -->
                    <div class="mt-4">
                        <a href="#" target="_blank" class="text-sm text-green-400 hover:underline">
                            Kunjungi Bio Saya
                        </a>
                        <div class="flex justify-center gap-4 mt-3">
                            <a href="#" target="_blank" title="Instagram" class="text-gray-400 hover:text-white">
                                <i data-lucide="instagram" class="w-5 h-5"></i>
                            </a>
                            <a href="#" target="_blank" title="TikTok" class="text-gray-400 hover:text-white">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-2.43.05-4.86-.95-6.69-2.81-1.77-1.8-2.55-4.16-2.4-6.6s.92-4.67 2.56-6.44c1.64-1.77 3.9-2.57 6.16-2.44.02 1.58-.02 3.16.01 4.73-.02 1.08-.36 2.14-1.05 2.95-.95 1.12-2.32 1.66-3.73 1.55-1.22-.09-2.39-.68-3.19-1.59-.53-.6-.82-1.36-.87-2.16-.07-1.15.25-2.31.97-3.26 1.45-1.9 3.96-2.62 6.17-1.69z"></path></svg>
                            </a>
                            <a href="#" target="_blank" title="Facebook" class="text-gray-400 hover:text-white">
                                <i data-lucide="facebook" class="w-5 h-5"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <div>
                    <h2 class="text-xl font-bold text-white mb-4">Kategori</h2>
                    <div id="category-list" class="space-y-2">
                        <!-- Kategori dimuat di sini -->
                    </div>
                    <button id="toggle-categories-btn" class="text-sm text-gray-400 hover:text-white mt-4 hidden">
                        Tampilkan Lebih Banyak
                    </button>
                </div>
            </aside>

            <!-- Konten Utama -->
            <main class="flex-1 bg-main-content p-6 overflow-y-auto">
                <div class="flex justify-between items-center mb-6 gap-4">
                    <h1 class="text-3xl font-bold text-white flex-shrink-0">Luthfi Music Web App</h1>
                    <div class="flex items-center gap-4 w-full justify-end">
                        <!-- Fitur Sortir -->
                        <div class="flex items-center gap-2">
                            <button id="sort-az-btn" class="sort-btn active p-2 bg-gray-800 rounded-full hover:bg-gray-700 transition-colors" title="Urutkan A-Z">
                                <i data-lucide="arrow-down-a-z" class="w-5 h-5"></i>
                            </button>
                            <button id="sort-za-btn" class="sort-btn p-2 bg-gray-800 rounded-full hover:bg-gray-700 transition-colors" title="Urutkan Z-A">
                                <i data-lucide="arrow-down-z-a" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <!-- Fitur Pencarian -->
                        <div class="relative w-1/2 max-w-xs">
                            <input type="search" id="search-input" placeholder="Cari lagu atau artis..." class="w-full bg-gray-800 text-white rounded-full py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-green-500">
                            <div class="absolute left-3 top-1/2 -translate-y-1/2">
                                <i data-lucide="search" class="text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="song-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                    <!-- Daftar lagu dimuat di sini -->
                </div>
            </main>
        </div>

        <!-- Player Bawah -->
        <footer class="bg-footer border-t border-gray-800 p-4 text-white">
            <div class="flex items-center justify-between">
                <div class="flex items-center w-1/3">
                    <img id="current-album-art" src="https://placehold.co/64x64/1DB954/FFFFFF?text=Musik" alt="Album Art" class="w-16 h-16 rounded-md mr-4 shadow-lg">
                    <div>
                        <h3 id="current-song-title" class="font-semibold">Pilih sebuah lagu</h3>
                        <p id="current-song-artist" class="text-sm text-gray-400">Tidak ada yang diputar</p>
                    </div>
                </div>
                <div class="w-2/3">
                    <audio id="audio-player" controls class="w-full"></audio>
                </div>
            </div>
            <!-- Copyright Footer -->
            <div class="text-center text-xs text-gray-500 mt-2">
                <p>&copy; 2025 Luthfi Kurnia</p>
            </div>
        </footer>
    </div>

    <!-- 5. LOGIKA JAVASCRIPT -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- [DIPERBARUI] URL API Anda sudah digabungkan di sini ---
            const GOOGLE_SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbxMEdy7CcgQxQG7o8MXRHf-5gH0OtnPSoyngMuLqgZpmyRjHhBJG0QPdzDXeSHnrlEN/exec';
            // -----------------------------------------------------------

            // --- Logika untuk Animasi Background ---
            const canvas = document.getElementById('wave-canvas');
            const ctx = canvas.getContext('2d');
            let step = 0;
            let hue = 200;
            const waves = [
                { y: 0, length: 0.02, amplitude: 120, frequency: 0.02, opacity: 0.5 },
                { y: 0, length: 0.03, amplitude: 150, frequency: 0.015, opacity: 0.3 },
                { y: 0, length: 0.015, amplitude: 100, frequency: 0.025, opacity: 0.8 }
            ];

            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                waves.forEach(w => w.y = canvas.height / 2);
            }

            function animateWave() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                hue += 0.5;
                waves.forEach(wave => {
                    const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
                    gradient.addColorStop(0, `hsla(${hue}, 100%, 50%, 0)`);
                    gradient.addColorStop(0.5, `hsla(${hue}, 100%, 50%, ${wave.opacity})`);
                    gradient.addColorStop(1, `hsla(${hue + 60}, 100%, 50%, 0)`);
                    ctx.beginPath();
                    ctx.moveTo(0, wave.y);
                    for (let i = 0; i < canvas.width; i++) {
                        ctx.lineTo(i, wave.y + Math.sin(i * wave.length + step) * wave.amplitude * Math.sin(step * 0.1));
                    }
                    ctx.strokeStyle = gradient;
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    ctx.closePath();
                });
                step += 0.02;
                requestAnimationFrame(animateWave);
            }
            
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            animateWave();

            // --- Logika Aplikasi Musik ---
            const songListContainer = document.getElementById('song-list');
            const categoryListContainer = document.getElementById('category-list');
            const toggleCategoriesBtn = document.getElementById('toggle-categories-btn');
            const audioPlayer = document.getElementById('audio-player');
            const currentAlbumArt = document.getElementById('current-album-art');
            const currentSongTitle = document.getElementById('current-song-title');
            const currentSongArtist = document.getElementById('current-song-artist');
            const searchInput = document.getElementById('search-input');
            const sortAzBtn = document.getElementById('sort-az-btn');
            const sortZaBtn = document.getElementById('sort-za-btn');

            let allSongs = [];
            let selectedCategories = new Set();
            let currentSong = null;
            let currentQueue = [];
            let currentSortOrder = 'a-z';
            const MAX_VISIBLE_CATEGORIES = 5;

            function startApp() {
                if (!GOOGLE_SHEET_API_URL || !GOOGLE_SHEET_API_URL.startsWith('https://script.google.com')) {
                    showError("URL API Google Sheet tidak valid. Harap periksa kembali URL di dalam kode.");
                    return;
                }
                fetchSongs(GOOGLE_SHEET_API_URL);
            }

            async function fetchSongs(apiUrl) {
                try {
                    const response = await fetch(apiUrl);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    allSongs = await response.json();
                    if (allSongs.length === 0) {
                       showError('Tidak ada lagu ditemukan. Pastikan sheet Anda berisi data.');
                       return;
                    }
                    renderCategories();
                    applyFiltersAndRender();
                    lucide.createIcons();
                } catch (error) {
                    console.error('Gagal mengambil data:', error);
                    showError('Gagal memuat data. Periksa URL API dan pastikan nama sheet Anda sudah benar.');
                }
            }
            
            function showError(message) {
                songListContainer.innerHTML = `<div class="col-span-full text-center p-8 bg-red-900 bg-opacity-50 rounded-lg"><h3 class="text-xl text-white font-bold">Oops! Terjadi Kesalahan</h3><p class="text-red-300 mt-2">${message}</p></div>`;
            }

            function renderCategories() {
                const categories = new Set();
                allSongs.forEach(song => song.kategori && song.kategori.split(',').forEach(cat => categories.add(cat.trim())));
                const sortedCategories = Array.from(categories).sort();
                categoryListContainer.innerHTML = '';
                const allCatElement = createCategoryElement('Semua Kategori');
                allCatElement.classList.add('active');
                allCatElement.addEventListener('click', handleCategoryClick);
                categoryListContainer.appendChild(allCatElement);
                sortedCategories.forEach((category, index) => {
                    const categoryElement = createCategoryElement(category);
                    if (index >= MAX_VISIBLE_CATEGORIES) categoryElement.classList.add('hidden');
                    categoryElement.addEventListener('click', handleCategoryClick);
                    categoryListContainer.appendChild(categoryElement);
                });
                if (sortedCategories.length > MAX_VISIBLE_CATEGORIES) {
                    toggleCategoriesBtn.classList.remove('hidden');
                }
            }
            
            function createCategoryElement(name) {
                const element = document.createElement('div');
                element.className = 'p-2 rounded-md cursor-pointer hover:bg-gray-800 transition-colors sidebar-item';
                element.textContent = name;
                element.dataset.category = name;
                return element;
            }

            function renderSongs(songs) {
                currentQueue = songs;
                songListContainer.innerHTML = '';
                if (songs.length === 0) {
                    songListContainer.innerHTML = `<p class="col-span-full text-center">Lagu tidak ditemukan.</p>`;
                    return;
                }
                songs.forEach(song => {
                    const songCard = document.createElement('div');
                    songCard.className = 'bg-gray-900/80 backdrop-blur-sm p-4 rounded-lg hover:bg-gray-800/80 transition-all cursor-pointer group';
                    songCard.innerHTML = `
                        <div class="relative">
                            <img src="${song.urlGambar || 'https://placehold.co/200x200/1DB954/FFFFFF?text=M'}" alt="${song.judulLagu}" class="w-full h-auto rounded-md shadow-lg mb-4 aspect-square object-cover">
                            <button class="absolute bottom-2 right-2 w-12 h-12 bg-green-500 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transform group-hover:translate-y-0 translate-y-2 transition-all duration-300 shadow-lg">
                                <i data-lucide="play"></i>
                            </button>
                        </div>
                        <h4 class="text-white font-semibold truncate">${song.judulLagu}</h4>
                        <p class="text-sm text-gray-400 truncate">${song.namaArtis}</p>
                    `;
                    songCard.addEventListener('click', () => playSong(song));
                    songListContainer.appendChild(songCard);
                });
                lucide.createIcons();
            }

            function applyFiltersAndRender() {
                let filteredSongs = [...allSongs];
                const searchTerm = searchInput.value.toLowerCase();
                if (searchTerm) {
                    filteredSongs = filteredSongs.filter(song => 
                        song.judulLagu.toLowerCase().includes(searchTerm) || 
                        song.namaArtis.toLowerCase().includes(searchTerm)
                    );
                }
                if (selectedCategories.size > 0) {
                    filteredSongs = filteredSongs.filter(song => {
                        const songCats = song.kategori ? song.kategori.split(',').map(c => c.trim()) : [];
                        return songCats.some(cat => selectedCategories.has(cat));
                    });
                }
                if (currentSortOrder === 'a-z') {
                    filteredSongs.sort((a, b) => a.judulLagu.localeCompare(b.judulLagu));
                } else if (currentSortOrder === 'z-a') {
                    filteredSongs.sort((a, b) => b.judulLagu.localeCompare(a.judulLagu));
                }
                renderSongs(filteredSongs);
            }

            function playSong(song) {
                currentSong = song;
                audioPlayer.src = song.urlAudio;
                currentAlbumArt.src = song.urlGambar || 'https://placehold.co/64x64/1DB954/FFFFFF?text=M';
                currentSongTitle.textContent = song.judulLagu;
                currentSongArtist.textContent = song.namaArtis;
                audioPlayer.play().catch(error => console.error("Gagal memutar audio:", error));
            }

            function playNextSong() {
                if (!currentSong || currentQueue.length === 0) return;
                const currentIndex = currentQueue.findIndex(song => song.judulLagu === currentSong.judulLagu);
                if (currentIndex === -1) return;
                const nextIndex = (currentIndex + 1) % currentQueue.length;
                const nextSong = currentQueue[nextIndex];
                playSong(nextSong);
            }

            function handleCategoryClick(event) {
                const clickedCategory = event.target.dataset.category;
                document.querySelectorAll('.sidebar-item.active').forEach(el => el.classList.remove('active'));
                if (clickedCategory === 'Semua Kategori') {
                    selectedCategories.clear();
                    event.target.classList.add('active');
                } else {
                    event.target.classList.toggle('active');
                    if (selectedCategories.has(clickedCategory)) {
                        selectedCategories.delete(clickedCategory);
                    } else {
                        selectedCategories.add(clickedCategory);
                    }
                    if (selectedCategories.size === 0) {
                        document.querySelector('[data-category="Semua Kategori"]').classList.add('active');
                    }
                }
                applyFiltersAndRender();
            }

            // --- EVENT LISTENERS ---
            searchInput.addEventListener('input', applyFiltersAndRender);
            audioPlayer.addEventListener('ended', playNextSong);
            sortAzBtn.addEventListener('click', () => {
                currentSortOrder = 'a-z';
                sortAzBtn.classList.add('active');
                sortZaBtn.classList.remove('active');
                applyFiltersAndRender();
            });
            sortZaBtn.addEventListener('click', () => {
                currentSortOrder = 'z-a';
                sortZaBtn.classList.add('active');
                sortAzBtn.classList.remove('active');
                applyFiltersAndRender();
            });
            toggleCategoriesBtn.addEventListener('click', () => {
                let isShowingMore = false;
                categoryListContainer.querySelectorAll('div').forEach((el, index) => {
                    if (index > MAX_VISIBLE_CATEGORIES) {
                        el.classList.toggle('hidden');
                        if (!el.classList.contains('hidden')) isShowingMore = true;
                    }
                });
                toggleCategoriesBtn.textContent = isShowingMore ? 'Lebih Sedikit' : 'Lebih Banyak';
            });

            // Mulai aplikasi saat halaman dimuat
            startApp();
        });
    </script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
    
    <!--
    ================================================================================
    PENTING: Untuk membuat fitur "Install Web App" (PWA) berfungsi,
    Anda perlu membuat 2 file tambahan di folder yang sama dengan file HTML ini.
    ================================================================================

    1. Buat file bernama `manifest.json` dan isi dengan kode berikut:
    
    {
        "name": "Luthfi Music Web App",
        "short_name": "Luthfi Music",
        "start_url": ".",
        "display": "standalone",
        "background_color": "#121212",
        "theme_color": "#1DB954",
        "description": "Aplikasi pemutar musik pribadi oleh Luthfi.",
        "icons": [
            {
                "src": "https://placehold.co/192x192/1DB954/FFFFFF?text=LM",
                "sizes": "192x192",
                "type": "image/png"
            },
            {
                "src": "https://placehold.co/512x512/1DB954/FFFFFF?text=LM",
                "sizes": "512x512",
                "type": "image/png"
            }
        ]
    }

    --------------------------------------------------------------------------------

    2. Buat file bernama `sw.js` (Service Worker) dan isi dengan kode berikut:

    const CACHE_NAME = 'luthfi-music-cache-v1';
    const urlsToCache = [
        '/',
        '/index.html', // Ganti 'index.html' jika nama file HTML Anda berbeda
        'https://cdn.tailwindcss.com',
        'https://unpkg.com/lucide@latest/dist/umd/lucide.min.js'
    ];

    self.addEventListener('install', event => {
        event.waitUntil(
            caches.open(CACHE_NAME)
                .then(cache => {
                    console.log('Opened cache');
                    return cache.addAll(urlsToCache);
                })
        );
    });

    self.addEventListener('fetch', event => {
        event.respondWith(
            caches.match(event.request)
                .then(response => {
                    if (response) {
                        return response;
                    }
                    return fetch(event.request);
                })
        );
    });
    ================================================================================
    -->

</body>
</html>
